# Sistema de Cadastro de Perguntas - Jogo da B√≠blia

Jogo da B√≠blia √© um jogo h√≠brido, ou seja, √© um jogo f√≠sico de tabuleiro de perguntas e respostas onde o usu√°rio anda certo n√∫mero de casas de acordo com o acerto da resposta obtida de cada, por√©m as cartas do jogo s√£o digitais, ent√£o funciona assim:

1. Tem um tabuleiro com casas coloridas e um QR code
2. Ao scanear o QR code o usu√°rio tem acesso √† tela do sistema onde √© poss√≠vel selecionar uma cor de cartas que apresentar√° a carta da pergunta a ser respondida

O cadastro de perguntas ser√° colaborativo e pessoas interessadas em produzir perguntas poder√£o faz√™-lo e ser√£o avaliadas pela equipe revisora, por isso os colaboradores s√≥ poder√£o ter acesso √† p√°gina estilizada de cadastro de perguntas enquanto os revisores poder√£o fazer altera√ß√£o nas perguntas e os publicadores, tanto editar quanto publicar as perguntas, tornando-as p√∫blicas para uso final dos jogadores.

## Inicializando

Voc√™ precisa ter o `docker` e o `docker-compose` instalado em sua m√°quina. para isso verifique os links de documenta√ß√£o proriet√°ria: [Docker](https://docs.docker.com/engine/install/) e [Docker-compose](https://docs.docker.com/compose/install/), nessa ordem.

Primeiramente leia a [se√ß√£o de arquivos .env](env) para setar as vari√°veis de ambiente como senhas de banco de dados. Para instalar todos os pacotes e depend√™ncias rode:

```
make build
```

Ou, se estiver usando o windows abra o arquivo `Makefile` e execute linha por linha do bloco `build`. Para saber mais [leia](makefile).

Acesse http://localhost:A_PORTA_QUE_VOCE_COLOCOU_EM_ENV e ver√° seu servi√ßo rodando. M√°gica? N√£o. Docker. üòâ

**Aten√ß√£o** Se n√£o aparecer o site pode ser porque, a primeira vez que √© gerado o banco de dados ele demora para inicializar, dessa forma o django tenta conectar com o banco e n√£o consegue, gerando erro. Verifique o `log` no terminal para ter certeza, mas se for esse o caso, execute:

```bash
make run
```

## Arquivos

<a id="env"></a>

### .env e .env.example

<a id="env"></a>

S√£o arquivos que guardam vari√°veis de ambiente, s√£o geralmente dados que precisam de uma seguran√ßa maior e n√£o podem ficar expostos no github, por isso sempre o `.env` fica no `.gitignore` e uma vers√£o sem os dados fica dispon√≠vel em `.env.example`. Voc√™ deve ent√£o copiar os dados de `.env.example` para `.env` e colocar os dados. Para isso use o comando abaixo:

```bash
cp .env.example .env
```

## Gerando chaves

Para gerar um `SECRET_KEY` para o Django ou um `SIGNING_KEY` para o pacote `simple-jwt` use:

```sh
python -c "import secrets; print(secrets.token_urlsafe())"
```

<a id="makefile"></a>

### Makefile

S√≥ funciona em linux, √© √∫til para executar blocos de c√≥digos juntos, sem precisar digitar um por um na linhas de comandos, ent√£o colocamos grupos de comandos que s√£o utilizados comumente juntos, para usar digite `make` e o nome do bloco, por exemplo:

```bash
make init
```

### Para ambiente de testes

Execute para resetar sem formatar o banco de dados:

```sh
# Se voc√™ quiser restaurar as configura√ß√µes iniciais do projeto para rodar novamente como se fosse a primeira vez
make reset
# √â bom aguardar depois de executar `make_run` para dar tempo de o banco de dados subir
make run
# Instale as aplica√ß√µes e migrations, se der erro da primeira vez ([Errno 111] Connection refused)"), execute novamente
make migrate
# Popule o banco de dados
make seed
# Crie um superusu√°rio
make superuser
# Depois de popular o banco ele pode cair
make run
```

Formatando o banco de dados e reiniciando o sistema para fins de produ√ß√£o em ambiente de desenvolvimento:

```sh
make reset_all
make makemigrations
make run
make seed
make superuser
make run
```

### Inicializando migra√ß√µes

```sh
docker exec -it jogodabiblia_cadastro_perguntas bash -c "cd /usr/src/app/app && python manage.py makemigrations"
docker exec -it jogodabiblia_cadastro_perguntas bash -c "cd /usr/src/app/app && python manage.py migrate"
```

### Criando superusu√°rio

```sh
docker exec -it jogodabiblia_cadastro_perguntas bash -c "cd /usr/src/app/app && python manage.py createsuperuser"
```

### Restaurando tabela postgres

```sh
psql -U postgres -f /initial_data/biblia_psql.sql
```

### Backup and Restore some table

**!! Deprecated !!**
```sh
# Backup
DB_TABLE=biblia_livro sh dump_table.sh
# Restore
cat backup.sql | docker exec -i CONTAINER /usr/bin/mysql -u root --password=root DATABASE
```

## Known Issues

- "Can't connect to MySQL server on 'db' ([Errno 111] Connection refused)") | Execute novamente `make run`

## To watch/compile sass

```sh
make sass
python manage.py sass app/perguntas/static/scss/ app/perguntas/static/css/ -t compressed
```

## Automatizando cria√ß√£o de perfis/grupos e permiss√µes

Os comando automatizados est√£o listados em `app/seed.py` e s√£o executados junto com o bloco de comandos `make seed`

## Criando tradu√ß√£o para portugu√™s do painel administrativo

```bash
docker exec -it jogodabiblia_cadastro_perguntas bash -c "django-admin makemessages --locale=pt_BR"
```
